---
# Travel planner
---

<!DOCTYPE html>
<html>
  <head>
    <title>USA 2018</title>
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" type="text/css" href="style.css">

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript">
var apiEndpoint = "{{site.travel.api_url}}?page=USA2018";
var iconBase = 'icons/';
var icons = {
  Investment: iconBase + 'dollar.png',
  Excursion: iconBase + 'museum.png',
  Landmark: iconBase + 'binoculars.png',
  Hotel: iconBase + 'bed.png',
};
var markers = {};
var map, infoWindow;

function initialize() {
  infoWindow = new google.maps.InfoWindow();

  //Map stylers, see: http://gmaps-samples-v3.googlecode.com/svn/trunk/styledmaps/wizard/index.html
  //Disable labels for "points-of-interest" (Keep icons)
  var styles = [{
    "featureType": "poi",
    "elementType": "labels",
    "stylers": [{"visibility": "off"}]
  }];

  var mapOptions = {
    center: new google.maps.LatLng(39.8793867, -75.04301670),
    zoom: 8,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    panControl: false,
    mapTypeControl: false,
    scaleControl: false,
    streetViewControl: false,
    overviewMapControl: false,
    rotateControl: false,
    styles: styles };
  map = new google.maps.Map(document.getElementById("map"), mapOptions);
  map.addListener('click', function(event) {
    createInfoWindow(-1, event.latLng);
  });

  var autocomplete = new google.maps.places.Autocomplete(document.getElementById("input-address-search"));
  autocomplete.bindTo('bounds', map);

  autocomplete.addListener('place_changed', function() {
    var place = autocomplete.getPlace();
    if (!place.geometry) return;

    // If the place has a geometry, then present it on a map.
    if (place.geometry.viewport) {
      map.fitBounds(place.geometry.viewport);
    } else {
      map.setCenter(place.geometry.location);
      map.setZoom(17);  // Why 17? Because it looks good.
    }
    createInfoWindow(-1, place.geometry.location);
  });

  $.ajax({
    url: apiEndpoint + '&handler=list',
    jsonp: "callback",
    dataType: "jsonp",
    success: function(response) {
      for (var i = 1; i < response.length; i++) {
        addMarker(response[i]);
      }
    }
  });
}

function getInfoWindowContent(id, lat, lng, title, category, description) {
  var idIsSet = id > 0;
  title = isStringNotNullOrEmpty(title) ? 'value="' + title + '" ' : '';
  category = isStringNotNullOrEmpty(category) ? 'value="' + category + '" ' : '';
  description = isStringNotNullOrEmpty(description) ? description : '';

  return '<form id="locationsForm" onsubmit="return false">' +
    (idIsSet ? '<input type="hidden" name="id" value="' + id + '">' : '') +
    '  <input type="hidden" name="lat" value="' + lat + '">' +
    '  <input type="hidden" name="lng" value="' + lng + '">' +

    '  <input type="text" class="bold" name="title" placeholder="e.g. 140 Grand Street" ' + title + '/>' +
    '  <input type="text" name="category" placeholder="e.g. Museum" ' + category + '/>' +

    '  <textarea name="description" rows="6" placeholder="Description">' + description + '</textarea>' +

    (idIsSet ?
      '  <input type="submit" onclick="updateLocation()" value="Update">' :
      '  <input type="submit" onclick="submitLocation()" value="Create">'
    ) +
    '</form>';
}

function createInfoWindow(id, position, title, category, description) {
  infoWindow.setPosition(position);
  infoWindow.setContent(getInfoWindowContent(id, position.lat(), position.lng(), title, category, description));
  infoWindow.open(map);
}

function submitLocation() {
  ajax('&handler=submit', $('#locationsForm').serialize(), function(response) {
  console.log('create: ', response);
      infoWindow.close();
      addMarker(response.data);
    }
  );
}

function updateLocation() {
  ajax('&handler=update', $('#locationsForm').serialize(), function(response) {
  console.log('update: ', response);
      if (response.updated) {
        markers[response.data[0]].meta = response.data;
        infoWindow.close();
      }
    }
  );
}

function addMarker(entry) {
  var marker = new google.maps.Marker({
    position: new google.maps.LatLng(entry[1], entry[2]),
    icon: icons[entry[4]],
    map: map,
    meta: entry
  });
  marker.addListener('click', function() {
    createInfoWindow(marker.meta[0], marker.position, marker.meta[3], marker.meta[4], marker.meta[5]);
  });
  marker.addListener('rightclick',  function() {
    ajax('&handler=remove', {id: marker.meta[0]}, function(response) {
      console.log('delete: ', response);
      if (response.removed) {
        delete markers[response.id];
        marker.setMap(null);
      }
    });
  });
  markers[entry[0]] = marker;
}

function ajax(query, data, callback) {
  $.ajax({
    url: apiEndpoint + query,
    jsonp: "callback",
    dataType: "jsonp",
    data: data,
    success: callback
  });
}

function isStringNotNullOrEmpty(variable) {
  return typeof variable === 'string' && variable.length > 0;
}
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{site.google.maps.api_key}}&libraries=places&callback=initialize" type="text/javascript"></script>
  </head>
  <body>
    <div id="container">
      <div id="search">
        <input type="text" id="input-address-search" placeholder="Address" />
      </div>
      <div id="map"></div>
    </div>
  </body>
</html>



