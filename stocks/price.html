---
layout: stocks_filter_table
title: Price
dashboard_class_name: "price-dashboard"
---

<script>
  document.addEventListener("DOMContentLoaded", function() {
    google.charts.load('visualization', '1.0', {'packages': ['table']});
    jsonp("{{site.stocks.api_url}}?page=price&user=" + getUser(), initialize);
  });

  function initialize(data) {
    data = data.map(function(elem, i) {
      if (i !== 0) elem[0] = new Date(elem[0]);
      return elem;
    });
            
    const date_formatter = new google.visualization.DateFormat({pattern: 'yyyy/MM/dd', timeZone: 0});
    const number_formatter = new google.visualization.NumberFormat();
    const percent_formatter = new google.visualization.NumberFormat({suffix: '%', fractionDigits: 3});
    const color_formatter = createColorFormat(1);
    
    const width = data[0].length;
    const format_data_table = dt => {
      date_formatter.format(dt, 0);
      
      for (let i = 1; i < width; i++) {
        if (i < width / 2) {
          number_formatter.format(dt, i);
        } else {
          color_formatter.format(dt, i);
          percent_formatter.format(dt, i);
        }
      }
    }
    
    {% include_relative _setup_date_filters_and_aggregators.js %}
    
    const chart = createChart({
      xAxis: {
        events: {
          setExtremes: filter,
        },
      },
      
      yAxis: {
        tickInterval: 5,
        labels: {
          formatter: function () {
            return (this.value > 0 ? '+' : '') + this.value + '%';
          },
        },
      },
      
      plotOptions: {
        series: {
          compare: 'percent',
        },
      },
      
      tooltip: {
        formatter: function() {
           let s = '<b>Date: ' + Highcharts.dateFormat('%Y/%m/%d', new Date(this.x)) + '</b><br/>';

           this.points
             .sort((a, b) => Math.sign(b.point.change - a.point.change))
             .forEach(point => {
                 s += '<br/><span style="color:' + point.series.color + ';font-weight:bold">' + point.series.name + '</span>: ' +
                      '<b>' + Highcharts.numberFormat(point.y, 2) + '</b> (' + Highcharts.numberFormat(point.point.change, 2) + '%)';
             });
           return s;
        },
      },
      
      series: range(1, data[0].length / 2).map(i => {
        const serie = data.map(function(row, j) { return j === 0 ? row[i] : [row[0].getTime(), row[i]]; });
        return {
          name: serie.shift(),
          data: serie,
        }
      }),
    });
  }
  
  function getNumberAggregator(mode, i, width) {
    switch(mode) {
      case 'average':
        return google.visualization.data.avg;
      
      case 'sum':
        if (i < width / 2) {
          return google.visualization.data.avg;
        } else {
          return percentAggregator;
        }
        
      case 'minimum':
        return google.visualization.data.min;
        
      case 'maximum':
        return google.visualization.data.max;
    }
  }
</script>
